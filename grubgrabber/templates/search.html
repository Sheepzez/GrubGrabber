{% extends "base.html" %}
{% load staticfiles %}

{% block title %}Search{% endblock %}

{% block content %}

<div class="row">
    <div class="small-12">
        Your search was <strong>{{ searchParam }}</strong>.
        <br>
        <div id="currentResult" class="panel">
            <div class="row">
                <div class="small-1 columns">
                    <img id="typeIcon" class="left" height="49" width="49"/>
                </div>
                <div class="small-7 columns">
                    <h1><span id="placeName"></span></h1>
                </div>
                <div class="small-4 columns">
                    <div id="placePhotoContainer">
                        <img id="placePhoto" src="http://placehold.it/329x150&text=Place Image">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="small-4 columns">
                    <div id="googleMap"></div>
                </div>
                <div class="small-8 columns">
                    Location: <span id="placeLocation"></span>
                </div>
            </div>
            <div class="row">
                <div class="small-12 columns">
                    <br>
                    <a class='button secondary' onClick='getNextResult()'>Get Next</a>
                    <a id ='this_place' class='button success' >Eat Here!</a>
                    <a class='button'>Favourite</a>
                    <a class='button alert'>Blacklist</a>
                </div>
            </div>

        </div>
        <hr>
    </div>
</div>
<br>
{% endblock %}

{% block javascript %}

<script src="http://maps.googleapis.com/maps/api/js?key={{ mapsKey }}&libraries=places"></script>
<script>
var map;
var geocoder;
var service;
var infowindow;
var searchLocation;
var searchResults;

function callback(results, status) {
    if (status == google.maps.places.PlacesServiceStatus.OK) {
        console.log(results);
        searchResults = results;
        var html;
        var result = searchResults.shift();
        $("#placeName").append(result["name"]);
        $("#placeLocation").append(result["vicinity"]);
        $("#typeIcon").attr("src",result["icon"]);
        if (result["photos"] != undefined) {
            $("#placePhoto").attr("src",result["photos"][0].getUrl({'maxHeight': 150}));
        } else {
            $("#placePhoto").attr("src","http://placehold.it/329x150&text=Place Image");
        }
        new google.maps.Marker({
            map: map,
            position: result["geometry"]["location"]
        });

    }
}

function getNextResult() {
    var result = searchResults.shift();
    if (result != undefined) {
        $("#placeName").html(result["name"]);
        $("#placeLocation").html(result["vicinity"]);
        $("#typeIcon").attr("src",result["icon"]);
        if (result["photos"] != undefined) {
            $("#placePhoto").attr("src",result["photos"][0].getUrl({'maxHeight': 150}));
        } else {
            $("#placePhoto").attr("src","http://placehold.it/329x150&text=Place Image");
        }
        new google.maps.Marker({
            map: map,
            position: result["geometry"]["location"]
        });
		placeID = place.placeId;
    } else {
        alert("No more places.");
    }
}

function codeAddress(address) {
    geocoder.geocode( { 'address': address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
            var locationObject = results[0].geometry.location;
            map.setCenter(locationObject);
            var marker = new google.maps.Marker({
                map: map,
                position: locationObject
            });
            var request = {
                location: locationObject,
                rankBy: google.maps.places.RankBy.DISTANCE,
                types: ['bakery','cafe','food','meal_takeaway','restaurant']
            };

            service = new google.maps.places.PlacesService(map);
            service.nearbySearch(request, callback);
        } else {
            alert('Geocode was not successful for the following reason: ' + status);
        }
    });
}

function initialize() {
    geocoder = new google.maps.Geocoder();
    var mapProp = {
        zoom:15,
        mapTypeId:google.maps.MapTypeId.ROADMAP
    };
    map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
    codeAddress("{{ searchParam }}");
}

function getKey() {
    var key;
    $.ajax("{% url 'getKey' %}", {
        success: function (data) {
            key = data;
        },
        async: false,
    });
    return key;
}

function getCoords(searchParam) {
    $.ajax("https://maps.googleapis.com/maps/api/geocode/json", {
        data: {address: searchParam},
        success: function (data) {
            searchPlaces(data["results"][0]["geometry"]["location"]);
        },
        async:false,
    });
}
</script>

<script>
google.maps.event.addDomListener(window, 'load', initialize);
</script>
{% endblock %}
